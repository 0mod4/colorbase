"use strict";var TwoD=function(){function e(){for(var e=0;T>e;e++)for(var n=0;C>n;n++)h.push("("+e+","+n+","+D[0]+","+D[1]+","+D[2]+","+D[3]+")")}function n(){p.run("CREATE TABLE dummy (x,y,r,g,b,a);");for(var e=[],n=0;T>n;n++)for(var r=0;C>r;r++)e.push("("+n),e.push(r),e.push(n==r?"200, 20, 100, 1)":"0,50,200,0.5)");p.run("INSERT INTO dummy VALUES "+e.join())}function r(){p.run("CREATE TABLE MUSIC (x,y,r,g,b,a);"),p.run("INSERT INTO MUSIC VALUES "+h.join())}function t(){p.run("CREATE TABLE VIDEO (x,y,r,g,b,a);"),p.run("INSERT INTO VIDEO VALUES "+h.join())}function a(){p.run("CREATE TABLE MOVE (x,y,r,g,b,a);"),p.run("INSERT INTO MOVE VALUES "+h.join())}function o(){p.run("CREATE TABLE CUBE (x,y,r,g,b,a);");var e=document.getElementById("imageCanvas"),n=document.getElementById("imgCube");e.getContext("2d").drawImage(n,0,0,C,T);for(var r=e.getContext("2d").getImageData(0,0,C,T).data,t=[],a=0;C>a;a++)for(var o=0;T>o;o++){var u=4*(o*C+a);t.push("("+a+","+o),t.push(r[u]),t.push(r[u+1]),t.push(r[u+2]),t.push(r[u+3]+")")}p.run("INSERT INTO CUBE VALUES "+t.join()),e.getContext("2d").clearRect(0,0,50,50),p.run("CREATE TABLE EVOKE (x,y,r,g,b,a);");var n=document.getElementById("imgEvoke");e.getContext("2d").drawImage(n,0,0,C,T),r=e.getContext("2d").getImageData(0,0,C,T).data,t=[];for(var a=0;C>a;a++)for(var o=0;T>o;o++){var u=4*(o*C+a);t.push("("+a+","+o),t.push(r[u]),t.push(r[u+1]),t.push(r[u+2]),t.push(r[u+3]+")")}p.run("INSERT INTO EVOKE VALUES "+t.join())}function u(){if(p.run("UPDATE MUSIC SET r=?, g=?, b=?, a=?",[0,0,0,0]),"undefined"!=typeof soundBars){var e=nSoundBars,n=1;C>e&&(n=Math.round(C/e));for(var r=soundBars[0],t=soundBars[0],a=1;e>a;a++)soundBars[a]>r&&(r=soundBars[a]),soundBars[a]<t&&(t=soundBars[a]);var o=(r-t)/T;o=300/T;for(var a=0;e>a;a++){var u;u="undefined"==typeof soundBars[a]?0:soundBars[a];var i=Math.floor(u/o);p.run("UPDATE MUSIC SET r=?, g=?, b=?, a=? WHERE y>? AND x BETWEEN ? AND ?",[musicColor[0],musicColor[1],musicColor[2],musicColor[3],T-i,a*n,(a+1)*n-1])}}}function i(){console.log("toggle 2D Music"),$("#playMusic").prop("checked")?(console.log("play"),playSound(),queryIntervalID>0&&$("#queryText").val().indexOf("MUSIC")>-1&&0==musicIntervalID&&(musicIntervalID=window.setInterval(function(){u()}))):(stopSound(),musicIntervalID>0&&(clearInterval(musicIntervalID),musicIntervalID=0))}function s(){video?$("#useVideo").prop("checked")?(useVideo(),queryIntervalID>0&&$("#queryText").val().indexOf("VIDEO")>-1&&0==videoIntervalID&&(console.log("start video interval"),videoIntervalID=window.setInterval(function(){l()},100))):(stopVideo(),videoIntervalID>0&&(clearInterval(videoIntervalID),videoIntervalID=0)):alert("Webcam access is not supported in your browser")}function l(){if($("#useVideo").prop("checked")){var e=document.getElementById("videoCanvas"),n=document.getElementById("camFeed");e.getContext("2d").drawImage(n,0,0,C,T);var r=e.getContext("2d").getImageData(0,0,C,T).data,t=[];p.run("DELETE FROM VIDEO");for(var a=0;C>a;a++)for(var o=0;T>o;o++){var u=4*(o*C+a);t.push("("+a+","+o),t.push(r[u]),t.push(r[u+1]),t.push(r[u+2]+",1)")}p.run("INSERT INTO VIDEO VALUES "+t.join())}else p.run("UPDATE VIDEO SET r=?, g=?, b=?, a=?",[D[0],D[1],D[2],D[3]])}function c(e,n){var r=40;e=10*Math.round(e/10),n=10*Math.round(n/10);var t=!0;return e!=n&&(n>e+r||e-r>n)&&(t=!1),t}function d(e,n,r,t,a,o){var u=c(e,t)&&c(n,a)&&c(r,o);return u}function v(){if(console.log("Update move table"),$("#useVideo").prop("checked")){var e=document.getElementById("videoCanvas"),n=document.getElementById("camFeed");e.getContext("2d").drawImage(n,0,0,C,T);var r=e.getContext("2d").getImageData(0,0,C,T).data;if(void 0!==typeof O[r.length-1]){p.run("DELETE FROM MOVE");for(var t=[],a=0;C>a;a++)for(var o=0;T>o;o++){t.push("("+a+","+o);var u=4*(o*C+a);t.push(d(r[u],r[u+1],r[u+2],O[u],O[u+1],O[u+2])?"0,0,0,0)":moveColor[0]+","+moveColor[1]+","+moveColor[2]+","+moveColor[3]+")")}p.run("INSERT INTO MOVE VALUES "+t.join())}O=r}else p.run("UPDATE MOVE SET r=?, g=?, b=?, a=?",[D[0],D[1],D[2],D[3]])}function I(){var e=$("#queryText").val();clearIntervals(),e.indexOf("MUSIC")>-1&&0==musicIntervalID&&(musicIntervalID=window.setInterval(function(){u()},100)),e.indexOf("VIDEO")>-1&&0==videoIntervalID&&(videoIntervalID=window.setInterval(function(){l()},100)),e.indexOf("MOVE")>-1&&0==moveIntervalID&&(moveIntervalID=window.setInterval(function(){v()},100)),intervalSet()?queryIntervalID=window.setInterval(function(){E(e)},100):E(e)}function E(e){var n=[],r=p.prepare(e);if(r){for(;r.step();){var t=r.getAsObject();n.push(t)}r.free()}else alert("Could not process statement");n.length>0?f(n):(alert("Empty result"),clearIntervals())}function f(e){function n(e,n,r){return Math.min(Math.max(e,n),r)}function r(e){$("#container").children().css({backgroundColor:"rgba(0,0,0,0)"});for(var r=0;r<e.length;r++){var a=[Math.round(e[r].x),Math.round(e[r].y)],o=0,u="cell"+a.join("-"),i=n(Math.round(e[r].r),0,255),s=n(Math.round(e[r].g),0,255),l=n(Math.round(e[r].b),0,255);o=-1!=t?t:n(e[r].a,0,1),$("#"+u).attr("data-clearcol",0),$("#cell"+a.join("-")).css({backgroundColor:"rgba("+i+","+s+","+l+","+o+")"})}}var t=-1;"x"in e[0]||alert("no x value selected"),"y"in e[0]||alert("no y value selected"),"r"in e[0]||alert("no r value selected"),"g"in e[0]||alert("no g value selected"),"b"in e[0]||alert("no b value selected"),"a"in e[0]||(t=1),r(e)}function g(){function u(){var e=$(".cell");d[0]=parseInt(e.css("margin-top"),10),d[1]=parseInt(e.css("margin-right"),10),d[2]=parseInt(e.css("margin-bottom"),10),d[3]=parseInt(e.css("margin-left"),10)}function i(){var e=$(window).height(),n=0,r=d[0]+d[2];return n=Math.floor(e/T-r)}function s(){var e=$(".cell"),n=e.width()*C,r=d[3]*C,t=n+r;return t}function l(e){var n=e,r=$(window).height(),t=Math.round((r-n)/2);return t}function c(e,n){for(var r=0;e>r;r++)for(var t=0;n>t;t++){var a=[t,r];$("#container").append("<div class='cell' id=cell"+a.join("-")+' data-clearcol="1"></div>')}}activeDim=2,nSoundBars=25,p=new SQL.Database,video?initVideo(T,C):alert("Your browser does not support GetUserMedia()");var d=($('input[name="Dimension"]:checked').val(),[]);c(T,C),u(),$(".cell").css({width:i()+"px",height:i()+"px"}),$("#container").css({width:s()+"px","margin-top":l(s())+"px"}),e(),n(),r(),t(),a(),o()}function m(){clearIntervals(),p.run("DROP TABLE dummy;"),p.run("DROP TABLE VIDEO;"),p.run("DROP TABLE MUSIC;"),p.run("DROP TABLE MOVE;"),p=null,$("#container *").remove(),$("#container").css({width:"100%"}),h=[],O=[],activeDim=0}var p,h=[],D=[255,255,255,.25],T=45,C=45,O=[];return{init:function(){g()},execute:function(){I()},cleanup:function(){m()},toggleVideo:function(){s()},toggleMusic:function(){i()}}}();