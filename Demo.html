<!doctype html>
<html lang="de">
<head>
	<link rel="stylesheet" href="css/normalize.css" media="screen" charset="utf-8">
	<link rel="stylesheet" href="css/style.css" media="screen" charset="utf-8">
	<script src='js/sql-memory-growth.js'></script>
	<script src='js/jquery.min.js'></script>
	<script src='js/caret.js'></script>
	<script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>

	<script id="shader-vs" type="x-shader/x-vertex" >
		attribute vec3 aVertexPosition;

	    void main(void) {
	        gl_Position = vec4(aVertexPosition, 1.0);
	    }
	</script>

	<script id="shader-fs" type="x-shader/x-fragment">
	    precision mediump float;

	    uniform mat4 uMVMatrix;
	    uniform mat4 uMVMatrixInverse;
		uniform int viewportWidth;
		uniform int viewportHeight;
		uniform int Nx;
		uniform int Ny;
		uniform int Nz;
		uniform int texWidth;

		uniform sampler2D uSampler;

		float precis = 0.002;
		vec3 playground;
		float cameraZ = -10.;

		float bound = 3.; //get 2*bound cubes in each direction

		float round(float p)
		{
			return floor(p+0.5);
		}

		vec3 getCellFromPos( vec3 pos )
		{
			//calculate from position which cell has been met
			//cells have size 1x1x1. bound gives howmany cells there are in each direction (2xbound)
			vec3 origp = (uMVMatrixInverse * vec4(pos, 1.)).xyz;
			//distance to first cell
			float startDist = -bound-cameraZ;
			origp.z += startDist;
			//cell (0,0,0) is at nearest top left corner
			float x = round(origp.x)+bound;
			float y = round(origp.y)+bound;
			float z = round(origp.z)+bound;

			return vec3(0);
		}

		vec2 TestCube(vec3 p)
		{
			vec3 d = abs(p)-vec3(5.);
			float col = 1.;
			//if(length(p)-0.5 < 1.8)
			//	col = 2.;
			//if(p.x > 0.5)
			//	col = 2.;
			return vec2(min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0)), col);
		}

		vec2 Boxes( vec3 p, vec3 c, float bound )
		{
			int col = 0;
			if((abs(p.x)<bound) && (abs(p.y)<bound) && (abs(p.z)<bound))
			{
				float size = 0.4;
				vec3 q = mod(p,c)-0.5*c;

			    if(q.x < 0.)
			    	col = 1;

			  	vec3 d = abs(q) - vec3(size);
			  	return vec2(min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0)), col);
			}
			else
				return vec2(precis+1., -1); //col = -1 means break
		}

		vec2 raytrace(vec3 ro, vec3 rd) //returns (m, colorInd)
		{
		    float maxZ = playground.x;
		    float step = 0.1;
		    vec3 repCellSize = vec3(1.);//playground / vec3(Nx, Ny, Nz);

		    float m = -1.0;
		    float col = 0.;
		    vec3 pos = ro;

		    for( int i=0; i<50; i++ )
		    {
				vec2 res = TestCube(pos);//Boxes(pos, repCellSize, bound);
				m = res.x;
				col = res.y;
				if( m<precis || pos.z>maxZ || col==-1. ) 
					break;
				pos = pos + rd*step;
			}

		    if( pos.z > maxZ) 
		    	m=-1.0;

		    vec2 ret = vec2(m, col);

		    return ret;
		}

		vec4 getColor(vec3 cell)
		{
			float s = cell.z*float(Ny)*float(Nx) + cell.y*float(Nx) + cell.x;
			return texture2D(uSampler, vec2(s/float(texWidth),0.5));
		}

		void main()
		{
			playground = vec3(50); //from -0.5*height to +0.5*height
			vec2 q = gl_FragCoord.xy/vec2(viewportWidth, viewportHeight);

			vec3 ro = vec3((q-vec2(0.5))*50., cameraZ);//vec3((q-vec2(0.5))*50., -10.);//vec3((q-vec2(0.5))*float(height), -1);
			vec3 rd = vec3(0,0,1);

			//rotate
			ro = (uMVMatrix * vec4(ro,1)).xyz;
			rd = (uMVMatrix * vec4(rd,0)).xyz;

			vec2 res = raytrace(ro, rd);
			float m = res.x;
			float col = res.y;
			if(m>-1.)
			{
				if(m <= precis)
				{
					if(col == 0.)
						gl_FragColor = vec4(1., 0., 0., 1.);
					if(col == 1.)
						gl_FragColor = vec4(0., 0., 1., 1.);
					if(col == 2.)
						gl_FragColor = vec4(1., 0., 1., 1.);
					if(col == 3.)
						gl_FragColor = vec4(0., 1., 0., 1.);
				}
				else
					gl_FragColor = vec4(0.);				
			}
			else
				gl_FragColor = vec4(0.);

		//	gl_FragColor = vec4(q, 0, 1);

			//vec4 textureColor = getColor(vec3(1,1,0));
			//gl_FragColor = textureColor;
		}
	</script>
	<script type='text/javascript' charset='utf-8' src='js/Demo.js'></script>
	<script type='text/javascript' charset='utf-8' src='js/Demo3D.js'></script>
	<script type='text/javascript' charset='utf-8' src='js/globals.js'></script>
	<script type='text/javascript' charset='utf-8' src='js/starfield.js'></script>
	<script type='text/javascript' charset='utf-8' src='js/gui.js'></script>
</head>

<script>
	$().ready(function() {
		$().initGUI();
	})

var numStars = 50;

	function toggleStarfield() {
		//start stars
 		if ($("#starfield_toggle").prop( "checked" )) {
 			$().createStarfield(numStars)
 		} else {
 			$().removeStarfield()
 		}
 	}

	function init() 
	{
		if($('input[name="Dimension"]:checked').val() == 3)
		{
			ThreeD.init()
		}
		else
		{
			TwoD.init()
		}
	}

	function toggleDimension()
	{
		if($('input[name="Dimension"]:checked').val() == "3")
		{
			ThreeD.cleanup()
			ThreeD.init()
		}
		else
		{
			TwoD.cleanup()
			TwoD.init()
		}
	}

	function toggleVideo()
	{
		TwoD.toggleVideo();
	}

	function execute()
	{
		if($('input[name="Dimension"]:checked').val() == "3")
			ThreeD.execute();
		else
			TwoD.execute();
	}
</script>

<body onload="init()">

	<div class="inputform">
		<form action="#" onsubmit="execute()" name="form" autocomplete="off">
			<input name="queryText" type="text" id="queryText" size="120" value="select * from dummy" autocomplete="off"><div class="marker"></div>
		</form>
 	</div>

 	<div class="optionform">
		<a href="#" class="toggle">Toggle Settings</a>
 		<form name="options">
			<fieldset>
				<input type="radio" id="in" name="Transition" value="in">
				<label for="in">Instant</label>
				<input type="radio" id="del" name="Transition" value="del">
				<label for="del">Delay</label>
			</fieldset>
			<fieldset>
				<label for="playMusic">Music</label>
				<input type="checkbox" id="playMusic" onClick="toggleMusic()" value="Play">
				<input type="text" id="numSoundBars" size="40" value="5">
				<label for="useVideo">Video</label>
				<input type="checkbox" id="useVideo" onClick="toggleVideo()" value="Play">
				<input type="radio" id="2D" name="Dimension" value="2" >
				<label for="2D">2D</label>
				<input type="radio" id="3D" name="Dimension" value="3" checked = "checked">
				<label for="3D">3D</label>
				<label for="starfield_toggle">OMG it's full of stars!</label>
				<input type="checkbox" id="starfield_toggle" onClick="toggleStarfield()" value="On">
			</fieldset>
		</form>
 	</div>

  <div id="videoDiv">
    	<video id="camFeed" width="320" height="240" autoplay></video>
    	<canvas id="videoCanvas" width="50" height="50"></canvas>
	</div>

	<div id="container">
		<!-- This is filled with cells later -->
	</div>

</body>
