<!doctype html>
<html lang="de">
<head>
	<script src='sql.js'></script>
	<script src="jquery.min.js"></script>
	<link rel="stylesheet" href="css/style.css" media="screen" charset="utf-8">
</head>

<script>
    var rows = 50;
    var cols = 50;
    var error = "";
    var parsedSelect;
    var clearColor = [255,255,255];

    var db;

    /*TABLE CREATION*/
    function createDefaultTable() {
	    db.run("CREATE TABLE dummy (x,y,r,g,b);");
	    var values = [];
	    for(var x=0; x<rows; x++)
	    {
	    	for(var y=0; y<cols; y++)
	    	{
	    		values = [];
	    		values.push(x);
	    		values.push(y);
	    		if(i==j)
	    		{
	    			values.push(200);
	    			values.push(20);
	    			values.push(100);
	    		}
	    		else
	    		{
	    			values.push(0);
	    			values.push(50);
	    			values.push(200);
	    		}
	    		db.run("INSERT INTO dummy VALUES (?,?,?,?,?)", values);
	    	}
	    }
    }

    function createMusicTable() {
    	db.run("CREATE TABLE MUSIC (x,y,r,g,b);");
	    for(var x=0; x<rows; x++)
	    {
	    	for(var y=0; y<cols; y++)
	    	{
	    		db.run("INSERT INTO MUSIC VALUES (?,?,?,?,?)", [x,y,0,0,0]]);
	    	}
	    }
    }

    /*TABLE UPDATES*/
    function updateMusicTable() {
    	
    }

    /*EXECUTING*/
	function query() {

		//publicSQL.query("SELECT F.x,F.y,F.r,F.g,F.b FROM FirstData F WHERE x = 0", "showResult"); 
		//preProcessor($("#queryText").val());
		var result = [];
		var stmt = db.prepare($("#queryText").val());
		if(stmt)
		{
			while(stmt.step()) {
		        var row = stmt.getAsObject();
		        result.push(row);
		    }
		}
		else
		{
			alert("Could not process statement");
		}
		showResult(result);
  	}

  	function showResult(result)
  	{
  		var transition = $('input[name="Transition"]:checked').val();
  		switch(transition) {
		    case "in":
				instantTransition(result);
		        break;
/*		    case "del":
		    	var prevTime = Date.now();
		        for(i=0; i<rows; i++)
		        {
		        	for(j=0; j<cols; j++)
		        	{
				  		for(c=0; c<result.length; c++)
				  		{
				  			colorSet = false;
				  			var id = [i,j];
				  			if(id == [Math.round(result[c][0]), Math.round(result[c][1])]) //current cell contained in result
				  			{
				  				$("#cell"+id.join("-")).css({backgroundColor: "rgb("+Math.round(result[c][2])+","+Math.round(result[c][3])+","+Math.round(result[c][4])+")"});
				  			}
				  			colorSet = true;
				  		}
				  		if(!colorSet)
				  		{
				  			$("#cell"+id.join("-")).css({backgroundColor: "rgb("+clearColor[0]+","+clearColor[1]+","+clearColor[2]+")"});
				  		}
						//while(Date.now()-prevTime < 2)
							console.log(Date.now()-prevTime);
						prevTime = Date.now();
		        	}
		        }
		        break;*/
		    default:
		        instantTransition(result);
		}
  	}

  	function clamp(val, min, max)
  	{
			return Math.min(Math.max(val, min), max);
  	}

  	function instantTransition(result)
  	{
		$("#container").children().css({backgroundColor: "rgb("+clearColor[0]+","+clearColor[1]+","+clearColor[2]+")"});
  		for(i=0; i<result.length; i++)
  		{
  			var r = clamp(Math.round(result[i].r), 0, 255);
  			var g = clamp(Math.round(result[i].g), 0, 255);
  			var b = clamp(Math.round(result[i].b), 0, 255);
  			var id = [Math.round(result[i].x), Math.round(result[i].y)]; //need x,y,r,g,b
  			$("#cell"+id.join("-")).css({backgroundColor: "rgb("+r+","+g+","+b+")"});
  		}
  	}

  	/*INITIALIZATION*/
  	function init()
  	{
		//build grid
		$("body").append("<div id='container'></div>");
		for(i=0;i<rows;i++){
			for(j=0;j<cols;j++){
				var id = [i,j];
				$("#container").append("<div class='cell' id=cell"+id.join("-")+"></div>");
				//$("#container").children().css({float: "left", width:"50px", height:"50px"});
			}
		}

		var x = ($('.cell').width() * cols);
		var y = (parseInt($('.cell').css('margin-left')) * cols)
		var containerWidth = x + y
  		$("#container").css({'width':containerWidth+'px'})

  		//db connection
  		db = new SQL.Database();

  		//create default table
  		createDefaultTable();
  	}
</script>

<body onload="init()">
	<div class="inputform">
			<form action="" name="form">
				<input name="queryText" type="text" id="queryText" size="120" value="select * from dummy">
				<input name="queryButton" type="button" id="queryButton" onClick="query()" value="my query">
			</form>
			<form name="options">
				<fieldset>
					<input type="radio" id="in" name="Transition" value="in">
					<label for="in">Instant</label>
					<input type="radio" id="del" name="Transition" value="del">
					<label for="del">Delay</label>
				</fieldset>
			</form>
	</div>
</body>
